 TODO: Rewrite this, this is a horrible mess